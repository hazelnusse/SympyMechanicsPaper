\documentclass{svjour3}                     % onecolumn (standard format)
\RequirePackage{fix-cm}

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}

%% Big-O notation.
\providecommand{\OO}[1]{\ensuremath{\operatorname{O}\bigl(#1\bigr)}}

\begin{document}

\title{A linearization procedure for constrained multibody systems}

\titlerunning{A linearization procedure for constrained multibody systems}        % if too long for running head

\author{Dale L. Peterson\and Gilbert Gede\and Mont Hubbard}

\institute{Dale L. Peterson, Gilbert Gede, Mont Hubbard \at
           Sports Biomechanics Laboratory\\
           Department of Mechanical and Aerospace Engineering\\
           University of California Davis\\
           Davis, CA 95616-5294\\
           Tel.: +1 530 752 2163\\
           \email{\{dlpeterson,ggede,mhubbard\}@ucdavis.edu}}

\date{Received: date / Accepted: date}

\maketitle

\begin{abstract}
  We present a systematic procedure for linearizing equations of motion
  governing constrained multibody systems which have been derived with Kane's
  method.  The procedure avoids differential algebraic equations and yields
  linear relationships between time derivatives of generalized
  coordinates/speeds (both independent and dependent) and independent
  generalized coordinates/speeds and exogenous inputs.  These minimal
  linearized equations effectively embed the constraints within them, and
  enable stability analysis and control system design without the need to
  explicitly address the constraints.  We numerically validate the results on a
  well studied model of a bicycle which includes both configuration and
  velocity constraints.
\keywords{symbolic dynamics, control, constrained multibody systems}
\end{abstract}

\section{Introduction}
\label{intro}

The goal of the following calculations is to concretely establish the first
order relationships (about an arbitrary equilibrium point) between an arbitrary
choice of independent coordinates and speeds, and the time-derivatives of all
coordinates and speeds (both independent and dependent).  This enables several
common tasks: (1) stability analysis, (2) control system design, (3) control
system design with output feedback based upon quantities that are dependent
(i.e., not state variables), (4) determination of measurement equations for use
in Kalman filter design when measured quantities are at the acceleration level
(i.e., accelerometers).  The formalism presented here is generic enough to
cover most examples of time-varying constrained multibody systems with
arbitrary external inputs and arbitrary specified quantities.  This procedure
has been created for systems whose equations of motion have been derived with
Kane's Method; while this is not a strict requirement, systems
which can be completely described by a set of ODEs is (i.e., no DAEs).

The complete configuration of the system is assumed to be described by
generalized coordinates $\bm{q}\in\bm{R}^n$ and its velocity completely
described by generalized speeds $\bm{u}\in\bm{R}^o$, with $n \ne o$ in general.
All coordinates and speeds, not only the independent ones, are represented by
$\bm{q}$ and $\bm{u}$.  The system is assumed to be governed by the
relationships described in table \ref{table:assumptions}.  The system is
described by $l + m + n + o$ equations which relate $2n + 2o + 2p + 1$
quantities, which implies that $n - l + o - m + p + 1$ of these quantities are
independent.  This paper discusses the first order relationship between these
independent quantities ($n-l$ independent coordinates, $o-m$ independent
speeds, $p$ control inputs, and time $t$) and the time derivatives of the $n$
coordinates and $o$ speeds.
%It is assumed that there are $l$
%configuration constraints (), and $m$ velocity constraints , and $m$ acceleration
%constraints (). Two functions $ relate the coordinate time derivatives to the generalized speeds,
%and two more functions $\bm{f}_2 : \mathbf{R}^n \times \mathbf{R}^o \times
%\mathbf{R} \to \mathbf{R}^{o-m}$ and $\bm{f}_3 : \mathbf{R}^n
%\times \mathbf{R}^n \times \mathbf{R}^o \times \mathbf{R}^p \times \mathbf{R}
%\to \mathbf{R}^{o-m}$ relate the time derivatives of the speeds $\bm{\dot{u}}$ to
%the externally applied inputs $\bm{r}\in\bm{R}^q$, coordinates $\bm{q}$ and
%their time derivatives $\bm{\dot{q}}$,  speeds $\bm{u}$, and time $t$. These
%assumptions can be summarized by the following equations
%\begin{align}
%  \label{eq:configuration}
%  \bm{f}_{c}(\bm{q}, t) &= \bm{0}\\
%  \label{eq:velocity}
%  \bm{f}_{v}(\bm{q}, \bm{u}, t) &= \bm{0}\\
%  \label{eq:acceleration}
%  \bm{f}_{a}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{\dot{u}}, t) &= \bm{0}\\
%  \label{eq:kindiffs}
%  \bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t)
%    + \bm{f}_{1}(\bm{q}, \bm{u}, t) &= \bm{0} \\
%  \label{eq:dyndiffs}
%  \bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t)
%    + \bm{f}_{3}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{r}, t) & = \bm{0}
%\end{align}
\begin{table}[htbp]
  \centering
  \caption{Constrained multibody system governing definitions and equations}
  \label{table:assumptions}
  \begin{tabular}[c]{l l l}
    Quantity & Shape & Description\\
    \hline
    $\bm{q},\bm{\dot{q}}$ & $\mathbf{R}^n$ & Coordinates and their time
    derivatives\\
    $\bm{u}, \bm{\dot{u}}$ & $\mathbf{R}^o$ & Speeds and their time derivatives\\
    $\bm{r}$ & $\mathbf{R}^p$ & Control inputs \\
  \end{tabular}
  \begin{tabular}[c]{r @{ $=$ } l l}
    \multicolumn{3}{c}{ } \\
    \multicolumn{2}{c}{Equation} & Description \\
    \hline
    $\bm{f}_{c}(\bm{q}, t)$ & $\bm{0}_{l \times 1}$ & Configuration constraints \\
    $\bm{f}_{v}(\bm{q}, \bm{u}, t)$ & $\bm{0}_{m \times 1}$ & Velocity constraints \\
    $\bm{f}_{a}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{\dot{u}}, t)$ & $\bm{0}_{m
    \times 1}$ & Acceleration constraints \\
    $\bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t) + \bm{f}_{1}(\bm{q}, \bm{u}, t)$ &
    $\bm{0}_{n \times 1}$ & Kinematic differential equations \\
    $\bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t) + \bm{f}_{3}(\bm{q}, \bm{\dot{q}},
    \bm{u}, \bm{r}, t)$ & $\bm{0}_{(o - m) \times 1}$ & Dynamic differential equations
  \end{tabular}
\end{table}
The first three equations in table \ref{table:assumptions} represent
constraints derived purely from kinematic considerations at the configuration,
velocity, and acceleration levels, respectively.  The velocity constraints may
be nonholonomic or differentiated holonomic, while the acceleration constraints
are assumed to be differentiated versions of the velocity constraints.  The
fourth equation represents kinematic differential equations which relate
$\bm{\dot{q}}$ and $\bm{u}$ and will be linear in both of these quantities.
The fifth equation represents the constraint free nonholonomic dynamic
differential equations~\cite{Kane1985}, and will necessarily by linear in
$\bm{\dot{u}}$ and input forces and torques $\bm{r}$, but generally nonlinear
in all other quantities.  This formalism is exceedingly generic; in practice,
the structure of the functions in table \ref{table:assumptions} can be
leveraged to simplify the following calculations.  This will be discussed
subsequently.

%The system described by equations \ref{eq:configuration}-\ref{eq:dyndiffs} has
%$o-m$ velocity degrees of freedom.
Trajectories of the system exist on a $p \triangleq n - l + o - m$ dimensional
manifold embedded in a $n + o$ dimensional space, though conserved quantities
(e.g., total mechanical energy) may restrict trajectories to a lower
dimensional manifold.  In general this cannot be assumed, however, especially
in the presence of external control inputs $\bm{r}$ which may change the total
mechanical energy of the system.  While more than $p$ of the independent state
variables may be of interest (i.e., dependent coordinates or speeds may be of
interest in themselves), only $p$ quantities are truly independent.  Which of
these $p$ coordinates and speeds should be chosen as independent out of the
possible $n + o$ may be obvious for small systems where there is intuition
about the system behavior, but in general the optimal choice depends on how the
configuration $\bm{q}$ affects the gradients of $f_c$ and $f_v$.  On the other
hand, in systems with cyclic/ignorable coordinates (i.e., coordinates which do
not appear in the dynamic equations of motion), fewer than $p$ state
variables may be of interest; one example is the Whipple bicycle model where
$p=10$ but 5 of these state variables are cyclic coordinates (coordinates of
rear wheel contact point, heading, and both wheel angles) and are often not of
much interest in themselves, nor are they necessary for most analyses.

\section{Derivation of linearization algorithm}
\label{derivations}

We see in Table \ref{table:assumptions} the differential equations which
describe our system. The goal of this procedure is to create linear equations
of motion with the following structure:
\begin{align}
    \label{eq:structure}
    \tilde{M} \dot{\bm{x}} = \tilde{A} \bm{x}_i + \tilde{B} \bm{r}
\end{align}
where $\bm{x}$ is the state vector of all the coordinates and speeds and
$\bm{x}_i$ is the state vector of only the independent coordinates and speeds.
From this equation we can perform numerical integration or stability analysis,
or it can be reformulated into the traditional state space equations for
controller design.

We begin with a first order Taylor series expansion of the equations in Table
\ref{table:assumptions} about $\bm{q}=\bm{q}^*$, $\bm{\dot{q}}=\bm{\dot{q}}^*$,
$\bm{u}=\bm{u}^*$, $\bm{\dot{u}}=\bm{\dot{u}}^*$, $\bm{r}=\bm{r}^*$; it is
assumed that all of the equations in Table \ref{table:assumptions} are
satisfied by these quantities.  In the interest of brevity, we omit writing
this equilibrium after each gradient in the calculations below; all are
evaluated at these equilibrium conditions.  Expansion of the three constraint
equations yields
\begin{align}
  \label{eq:configuration_expansion}
  \bm{f}_{c}(\bm{q}, t) &\approx \underbrace{f_{c}(\bm{q}^*, t)}_{\bm{0}} +
    \nabla_{\bm{q}}f_{c} \cdot \delta \bm{q}\\
  \label{eq:velocity_expansion}
  \bm{f}_{v}(\bm{q}, \bm{u}, t) &\approx \underbrace{\bm{f}_{v}(\bm{q}^*,
  \bm{u}^*, t)}_{\bm{0}} +  \nabla_{\bm{q}}f_{v} \cdot \delta \bm{q} +
  \nabla_{\bm{u}}f_{v} \cdot \delta \bm{u} \\
  \label{eq:acceleration_expansion}
  \bm{f}_{a}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{\dot{u}}, t) &\approx
  \underbrace{\bm{f}_{a}(\bm{q}^*, \bm{\dot{q}}^*, \bm{u}^*, \bm{\dot{u}}^*,
t)}_{\bm{0}} +  \nabla_{\bm{q}}f_{a} \cdot \delta \bm{q} + \nabla_{\bm{\dot{q}}}f_{a}
\cdot \delta \bm{\dot{q}} \notag\\
&+ \nabla_{\bm{u}}f_{a} \cdot \delta \bm{u} + \nabla_{\bm{\dot{u}}}f_{a} \cdot
\delta \bm{\dot{u}}
\end{align}
The first terms are identically zero because of the assumption that the
equilibrium point satisfies the constraints.  The Taylor series expansion of
the kinematic differential equations is
\begin{align}
  \label{eq:f0_expansion}
  \bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t) &\approx \bm{f}_{0}(\bm{q}^*,
  \bm{\dot{q}}^*, t) + \nabla_{\bm{q}}\bm{f}_{0} \cdot \delta\bm{q} +
  \nabla_{\bm{\dot{q}}}\bm{f}_{0} \cdot \delta\bm{\dot{q}}\\
  \label{eq:f1_expansion}
  \bm{f}_{1}(\bm{q}, \bm{u}, t) &\approx \bm{f}_{1}(\bm{q}^*,
  \bm{u}^*, t) + \nabla_{\bm{q}}\bm{f}_{1} \cdot \delta\bm{q} +
  \nabla_{\bm{u}}\bm{f}_{1} \cdot \delta\bm{u}
\end{align}
Summing (\ref{eq:f0_expansion}) and (\ref{eq:f1_expansion}) and recognizing
that the sum of the first term on the right hand side of each equation must
equal zero, we obtain
\begin{align}
  \label{eq:f0_plus_f1_expansion}
  \bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t) + \bm{f}_{1}(\bm{q}, \bm{u}, t) &\approx
  \nabla_{\bm{q}}(\bm{f}_{0} + \bm{f}_{1}) \cdot \delta\bm{q} +
  \nabla_{\bm{\dot{q}}}\bm{f}_{0} \cdot \delta\bm{\dot{q}} +
  \nabla_{\bm{u}}\bm{f}_{1} \cdot \delta\bm{u}
\end{align}
Similarly, a Taylor series expansion of the dynamic differential equations, we
obtain
\begin{align}
  \label{eq:f2_expansion}
  \bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t) &\approx
      \bm{f}_{2}(\bm{q}^*, \bm{\dot{u}}^*, t) +
      \nabla_{\bm{q}}\bm{f}_{2} \cdot \delta\bm{q}
      + \nabla_{\bm{\dot{u}}}\bm{f}_{2} \cdot \delta\bm{\dot{u}}\\
  \bm{f}_{3}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{r}, t) &\approx
  \bm{f}_{3}(\bm{q}^*, \bm{\dot{q}}^*, \bm{u}^*, \bm{r}^*, t) +
  \nabla_{\bm{q}}\bm{f}_{3} \cdot \delta\bm{q}\notag\\
  \label{eq:f3_expansion}
  &+ \nabla_{\bm{\dot{q}}}\bm{f}_{3} \cdot \delta\bm{\dot{q}}
  + \nabla_{\bm{u}}\bm{f}_{3} \cdot \delta \bm{u}
  + \nabla_{\bm{r}}\bm{f}_{3} \cdot \delta\bm{r}
\end{align}
Summing (\ref{eq:f2_expansion}) and (\ref{eq:f3_expansion}) and recognizing
that the sum of the first term on the right hand sides of these equations must
equal zero, we obtain
\begin{align}
  \bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t) + \bm{f}_{3}(\bm{q}, \bm{\dot{q}},
  \bm{u}, \bm{r}, t) &\approx \nabla_{\bm{q}}(\bm{f}_2 + \bm{f}_3) \cdot
  \delta\bm{q} + \nabla_{\bm{\dot{q}}}\bm{f}_{3} \cdot \delta\bm{\dot{q}}\notag\\
  \label{eq:f2_plus_f3_expansion}
  &+ \nabla_{\bm{u}}\bm{f}_{3} \cdot \delta\bm{u} +
  \nabla_{\bm{\dot{u}}}\bm{f}_{2} \cdot \delta\bm{\dot{u}} + \nabla_{\bm{r}}\bm{f}_{3} \cdot \delta\bm{r}
\end{align}

Equating the right hand sides of equations (\ref{eq:f0_plus_f1_expansion}),
(\ref{eq:acceleration_expansion}),
and (\ref{eq:f2_plus_f3_expansion}) to zero (as per table
\ref{table:assumptions}), and introducing the following definitions
\begin{align}
    \label{eq:quant_to_compute}
    \begin{array}{llcll}
\tilde{M}_{qq}  &\triangleq \nabla_{\bm{\dot{q}}}\bm{f}_0 & \quad &
\tilde{M}_{uqc} &\triangleq \nabla_{\bm{\dot{q}}}\bm{f}_a \\
\tilde{M}_{uuc} &\triangleq \nabla_{\bm{\dot{u}}}\bm{f}_a & \quad &
\tilde{M}_{uqd} &\triangleq \nabla_{\bm{\dot{q}}}\bm{f}_2 \\
\tilde{M}_{uud} &\triangleq \nabla_{\bm{\dot{u}}}\bm{f}_2 & \quad &
\tilde{A}_{qq}  &\triangleq -\nabla_{\bm{q}}(\bm{f}_0 + \bm{f}_1) \\
\tilde{A}_{qu}  &\triangleq -\nabla_{\bm{u}}\bm{f}_1 & \quad &
\tilde{A}_{uqc} &\triangleq -\tilde{A}_{qq} - \nabla_{\bm{q}} \bm{f}_a \\
\tilde{A}_{uuc} &\triangleq -\tilde{A}_{qu} - \nabla_{\bm{u}} \bm{f}_a & \quad &
\tilde{A}_{uqd} &\triangleq -\tilde{A}_{qq} - \nabla_{\bm{q}} (\bm{f}_2 + \bm{f}_3) \\
\tilde{A}_{uud} &\triangleq -\tilde{A}_{qu} - \nabla_{\bm{u}} \bm{f}_3 & \quad &
\tilde{B}_{u}   &\triangleq -\nabla_{\bm{r}}\bm{f}_{3}
\end{array}
\end{align}
enables the unconstrained linear state space equations to be written as
\begin{align}
  \label{eq:state_space_unconstrained}
  \left[
    \begin{array}{cc}
      \tilde{M}_{qq} & \bm{0}_{n \times o} \\
      \tilde{M}_{uqc} & \tilde{M}_{uuc} \\
      \tilde{M}_{uqd} & \tilde{M}_{uud}
    \end{array}
    \right]
    \left[
      \begin{array}{c}
        \delta \bm{\dot{q}} \\
        \delta \bm{\dot{u}}
      \end{array}
    \right]
   &=
   \left[
     \begin{array}{cc}
       \tilde{A}_{qq} & \tilde{A}_{qu} \\
       \tilde{A}_{uqc} & \tilde{A}_{uuc} \\
       \tilde{A}_{uqd} & \tilde{A}_{uud}
     \end{array}
   \right]
    \left[
      \begin{array}{c}
        \delta \bm{q} \\
        \delta \bm{u}
      \end{array}
    \right]
    +
    \left[
      \begin{array}{c}
        \bm{0}_{(n + m) \times q} \\
        \tilde{B}_{u}
      \end{array}
    \right]
    \delta \bm{r}
\end{align}
Equation (\ref{eq:state_space_unconstrained}) has a state space of dimension $n
+ o$, yet only $p = n - l + o - m$ of these quantities are independent.
To address this issue, a particular set of independent
coordinates and speeds must be selected. To this end, consider the following
partitioning of the generalized coordinates and generalized speeds:
\begin{equation*}
  \tilde{\bm{q}} \triangleq \left[\begin{array}{cc}\bm{q}_{i} &
      \bm{q}_{d}\end{array}\right]^{T} =  P_{q}^{-1} \bm{q}
      \qquad\qquad
  \tilde{\bm{u}} \triangleq \left[\begin{array}{cc}\bm{u}_{i} &
      \bm{u}_{d}\end{array}\right]^{T} =  P_{u}^{-1} \bm{u}
\end{equation*}
where $P_q \in \mathbf{R}^{n \times n}$ and $P_u \in \mathbf{R}^{o \times o}$
are invertible permutation matrices which map an ordering which has the
independent quantities ($\bm{q}_{i}\in\mathbf{R}^{n-l},\,
\bm{u}_{i}\in\mathbf{R}^{o-m})$ first, followed by the dependent quantities
($\bm{q}_{d}\in\mathbf{R}^{l},\, \bm{u}_{d}\in\mathbf{R}^{m}$) to the
original ordering of the coordinates and speeds.  We use the notation $P_{qi}$
and $P_{qd}$ to denote the first $n-l$ and last $l$ columns of $P_q$,
respectively; similarly, $P_{ui}$ is the first $o-m$ columns of $P_{u}$ while
$P_{ud}$ is the last $m$ columns of $P_u$.

Setting the right hand side of equation (\ref{eq:configuration_expansion}) equal to
zero, and making use of $P_q$, we have
\begin{align}
  \nabla_{\bm{q}}\bm{f}_{c} P_{q} \cdot \delta \bm{\tilde{q}} &=
  \nabla_{\bm{q}}\bm{f}_{c} P_{qi} \cdot \delta \bm{q_i} +
  \nabla_{\bm{q}}\bm{f}_{c} P_{qd} \cdot \delta \bm{q_d}\notag\\
  &= \bm{0}\notag\\
  \implies \delta \bm{q}_d &= -(\nabla_{\bm{q}}\bm{f}_{c} P_{qd})^{-1}
  (\nabla_{\bm{q}}\bm{f}_{c} P_{qi}) \cdot \delta \bm{q}_i \notag\\
  \implies \delta \bm{q} &= \left[ I_{n \times n} - P_{qd}(\nabla_{\bm{q}}
    \bm{f}_{c} P_{qd})^{-1} \nabla_{\bm{q}} \bm{f}_{c} \right] P_{qi} \cdot \delta
    \bm{q}_i
\end{align}
For convenience, we define
\begin{equation}
  \label{eq:C_0}
  C_0 \triangleq \left[ I_{n \times n} - P_{qd}(\nabla_{\bm{q}}
    \bm{f}_{c} P_{qd})^{-1} \nabla_{\bm{q}} \bm{f}_{c} \right] P_{qi}
\end{equation}
which enables us to write
\begin{align}
  \label{eq:delta_q}
  \delta \bm{q} &= C_0 \cdot \delta \bm{q}_i
\end{align}

Applying the same approach to (\ref{eq:velocity_expansion}), we obtain
\begin{align}
  \nabla_{\bm{q}}\bm{f}_{v} \cdot \delta \bm{q} +
  \nabla_{\bm{u}}\bm{f}_{v} \cdot \delta \bm{u} &= \nabla_{\bm{q}} \bm{f}_{v} \cdot
\delta \bm{q} + \nabla_{\bm{u}} \bm{f}_{v} P_{ui} \cdot \delta \bm{u}_i +
\nabla_{\bm{u}} \bm{f}_{v} P_{ud} \cdot \delta \bm{u}_d \notag\\
&= \bm{0}\notag\\
\implies \delta \bm{u}_d &= -\left(\nabla_{\bm{u}} \bm{f}_{v}
P_{ud}\right)^{-1}\left[\nabla_{\bm{q}}\bm{f}_{v} \cdot \delta\bm{q} +
  \nabla_{\bm{u}} \bm{f}_{v} P_{ui} \cdot \delta \bm{u}_i \right]\notag\\
  \implies \delta \bm{u} &= -P_{ud}(\nabla_{\bm{u}} \bm{f}_{v} P_{ud})^{-1}
  \nabla_{\bm{q}} \bm{f}_{v} \cdot \delta \bm{q}\notag\\
  &+ \left[I - P_{ud} (\nabla_{\bm{u}}\bm{f}_{v} P_{ud})^{-1} \nabla_{\bm{u}}
    \bm{f}_{v} \right] P_{ui} \cdot \delta \bm{u}_i
\end{align}
We define
\begin{align}
  \label{eq:C_1}
  C_1 &\triangleq -P_{ud}(\nabla_{\bm{u}} \bm{f}_{v} P_{ud})^{-1}
  \nabla_{\bm{q}} \bm{f}_{v} \\
  \label{eq:C_2}
  C_2 &\triangleq \left[I - P_{ud} (\nabla_{\bm{u}}\bm{f}_{v} P_{ud})^{-1} \nabla_{\bm{u}}
    \bm{f}_{v} \right] P_{ui}
\end{align}
which enables us to write
\begin{align}
  \label{eq:delta_u}
  \delta \bm{u} &= C_1 \cdot \delta \bm{q} + C_2 \cdot \delta \bm{u}_i\notag\\
  &= C_1 C_0 \cdot \delta \bm{q}_i + C_2 \cdot \delta \bm{u}_i
\end{align}

By making use of equations (\ref{eq:delta_q}) and (\ref{eq:delta_u}), we can
rewrite equation (\ref{eq:state_space_unconstrained}) as
\begin{align}
  \label{eq:state_space_constrained}
  \left[
    \begin{array}{cc}
      \tilde{M}_{qq} & \bm{0}_{n \times o} \\
      \tilde{M}_{uqc} & \tilde{M}_{uuc} \\
      \tilde{M}_{uqd} & \tilde{M}_{uud}
    \end{array}
    \right]
    \left[
      \begin{array}{c}
        \delta \bm{\dot{q}} \\
        \delta \bm{\dot{u}}
      \end{array}
    \right]
   &=
   \left[
     \begin{array}{cc}
       (\tilde{A}_{qq} + \tilde{A}_{qu} C_1 ) C_0 & \tilde{A}_{qu} C_2 \\
       (\tilde{A}_{uqc} + \tilde{A}_{uuc} C_1 ) C_0 & \tilde{A}_{uuc} C_2\\
       (\tilde{A}_{uqd} + \tilde{A}_{uud} C_1 ) C_0 & \tilde{A}_{uud} C_2
     \end{array}
   \right]
    \left[
      \begin{array}{c}
        \delta \bm{q}_i \\
        \delta \bm{u}_i
      \end{array}
    \right]
    +
    \left[
      \begin{array}{c}
        \bm{0}_{(n+m) \times q} \\
        \tilde{B}_{u}
      \end{array}
    \right]
    \delta \bm{r}
\end{align}

We now have a linear system of equations which relates the time derivatives of all
states, dependent or independent, to the independent coordinates, independent
speeds, and exogenous inputs.

\section{Discussion}

There are a number of additional steps needed to use these linear equations or
lorm them more efficiently. There are also non-singularity requirements
involved in selection of independent quantities.

In order to use these equations in the state space representation, 2 things
need to happen. First, matrices $\tilde{A}$ and $\tilde{B}$ need to be
multiplied by the mass matrix inverse. We can then define

\begin{align}
    A^\prime &\triangleq \tilde{M}^{-1} \tilde{A} \\
    B^\prime &\triangleq \tilde{M}^{-1} \tilde{B}
\end{align}

Now we will have matrices $A^\prime$ and $B^\prime$ which are of size $(o +
n) \times (o - m + n - l)$ and $(o + n) \times p)$. We need to now extract only
the rows which are associated with the independent quantities. We will call the
new reduced matrices $A$ and $B$ and compute them with the following

\begin{align}
    P^\prime &\triangleq \begin{bmatrix}
        P_{qi} & \bm{O}_{n \times (o - m)} \\
        \bm{O}_{o \times (n - l)} & P_{ui}
    \end{bmatrix} \\
    A &\triangleq P^{\prime T} A^\prime \\
    B &\triangleq P^{\prime T} B^\prime
\end{align}

We will also define the state space vector $x =
\left[\delta\bm{q}_i,\,\delta\bm{u}_i\right]^{T}$; we now have the traditional
state space representation which only contains independent quantities.

This method relies on the nonsingularity of $\nabla_{\bm{q}}\bm{f}_{c} P_{qd}$
and $\nabla_{\bm{u}} \bm{f}_{v} P_{ud}$.  The implication of this is that
selection of dependent coordinates and dependent speeds is critical.  The
permutation matrices effectively select the columns of the constraint gradient
matrices, and may be selected by examination of the constraint gradient matrix
through a SVD or other numerical techniques; for small systems it may be
possible to choose dependent speeds without resorting to numerical techniques
if the system trajectories stay with the configuration space where these
matrices are nonsingular.

% Not sure which bibliography style we are supposed to use
%\bibliographystyle{spphys}       % APS-like style for physics
%\bibliographystyle{spbasic}      % basic style, author-year citations
\section{Conclusion}
In this paper, we have presented a procedure for creating linear equations of
motion for a system with holonomic and nonholonomic constraints. We have also
described some of the considerations that must be made when following this
procedure as well as a numerical example showing the results of and validating
our procedure.

In summary, the procedure is:

\begin{enumerate}
    \item Describe the system in the form of the equations shown in Table
        \ref{table:assumptions}.
    \item Compute the quantities shown in equation (\ref{eq:quant_to_compute}).
    \item Either through inspection or performing a SVD on
        $\nabla_{\bm{q}}\bm{f}_{c} P_{qd}$
        and $\nabla_{\bm{u}} \bm{f}_{v} P_{ud}$, create the partition matrices
        $P_u$ and $P_q$ which correctly identify the independent coordinates and
        speeds.
    \item Form the quantities in equations (\ref{eq:C_0}), (\ref{eq:C_1}), and
        (\ref{eq:C_2}); using these terms and those from equation
        (\ref{eq:quant_to_compute}), form equation
        (\ref{eq:state_space_constrained}).
    \item Choose a point of linearization which satisfies the equations in
        Table \ref{table:assumptions} and:
        \begin{enumerate}
            \item integrate the equations of motion.
            \item reformulate the equations into the traditional state space form.
            \item perform stability analysis.
            \item perform other analyses.
        \end{enumerate}
\end{enumerate}

\begin{acknowledgements}
  This material is based upon work partially supported by the National Science
  Foundation under award 0928339 and two Google Summer of Code projects (2009,
  2011).  Aaron Muerer, Brian Granger, Mateuz Paprocki, and Ondrej Certik
  provided valuable help with SymPy and Python.  Jason Moore, Thomas Johnston,
  Evan Sperber, and Andrew Kickertz provided valuable feedback during
  discussions of multibody dynamics and control related issues.
\end{acknowledgements}


\bibliography{references}   % name your BibTeX data base
\bibliographystyle{spmpsci}      % mathematics and physical sciences
\end{document}
