\documentclass{svjour3}                     % onecolumn (standard format)
\RequirePackage{fix-cm}

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}

%% Big-O notation.
\providecommand{\OO}[1]{\ensuremath{\operatorname{O}\bigl(#1\bigr)}}

\begin{document}

\title{Open source symbolic multibody dynamics software}

\titlerunning{Open source symbolic multibody dynamics software}        % if too long for running head

\author{Dale L. Peterson\and Gilbert Gede\and Mont Hubbard}

\institute{Dale L. Peterson, Gilbert Gede, Mont Hubbard \at
           Sports Biomechanics Laboratory\\
           Department of Mechanical and Aerospace Engineering\\
           University of California Davis\\
           Davis, CA 95616-5294\\
           Tel.: +1 530 752 2163\\
           \email{\{dlpeterson,ggede,mhubbard\}@ucdavis.edu}}

\date{Received: date / Accepted: date}

\maketitle

\begin{abstract}
  Abstract here.
\keywords{symbolic dynamics software, nonholonomic systems, control}
\end{abstract}

\section{Introduction}
\label{intro}

\section{Derivation of linearization algorithm}
\label{derivations}
The goal of the following calculations is to concretely establish the first
order relationships (about an arbitrary equilibrium point) between an arbitary
choice of independent coordinates and speeds, and the time-derivatives of all
coordinates and speeds (both independent and dependent).  This enables several
common tasks: (1) stability analysis of arbitrary equilibria, (2) traditional
control system design, (3) control system design with output feedback based
upon quantities that are dependent (i.e., not state variables), (4)
determination of measurement equations for use in Kalman filter design when
measured quantities are at the acceleration level (i.e., accelerometers).  The
formalism presented here is generic enough to cover most examples of
time-varying constrained multibody systems with arbitrary external inputs and
arbitrary specified quantities.

The complete configuration of the system is assumed to be described by
generalized coordinates $\bm{q}\in\bm{R}^n$, its velocity completely described
by generalized speeds $\bm{u}\in\bm{R}^o$.  It is assumed that there are $l$
holonomic constraints ($f_h : \mathbf{R}^n \times \mathbf{R} \to
\mathbf{R}^l$), and $m$ nonholonomic constraints ($f_{nh} : \mathbf{R}^n \times
\mathbf{R}^o \times \mathbf{R} \to \mathbf{R}^l$). Two functions $\bm{f}_0 :
\mathbf{R}^n \times \mathbf{R}^n \times \mathbf{R} \to \mathbf{R}^n$ and
$\bm{f}_1 : \mathbf{R}^n \times \mathbf{R}^o \times \mathbf{R} \to
\mathbf{R}^n$ relate the coordinate time derivatives to the generalized speeds,
and two more functions $\bm{f}_2 : \mathbf{R}^n \times \mathbf{R}^o \times
\mathbf{R} \to \mathbf{R}^o$ and $\bm{f}_3 : \mathbf{R}^n
\times \mathbf{R}^n \times \mathbf{R}^o \times \mathbf{R}^p \times \mathbf{R}
\to \mathbf{R}^o$ relate the time derivatives of the speeds $\bm{\dot{u}}$ to
the externally applied inputs $\bm{r}\in\bm{R}^q$, coordinates $\bm{q}$ and
their time derivatives $\bm{\dot{q}}$,  speeds $\bm{u}$, and time $t$. These
assumptions can be summarized by the vector equations
\begin{align}
  \label{eq:holonomic}
  \bm{f}_{h}(\bm{q}, t) &= \bm{0}\\
  \label{eq:nonholonomic}
  \bm{f}_{nh}(\bm{q}, \bm{u}, t) &= \bm{0}\\
  \label{eq:kindiffs}
  \bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t)
    + \bm{f}_{1}(\bm{q}, \bm{u}, t) &= \bm{0} \\
  \label{eq:dyndiffs}
  \bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t)
    + \bm{f}_{3}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{r}, t) & = \bm{0}
\end{align}
where equations (\ref{eq:holonomic}) and (\ref{eq:nonholonomic}) are the
holonomic and nonholonomic constraints (and possibly time differentiated holonomic
constraints), respectively. Equations (\ref{eq:kindiffs}) are the kinematic differential equations
(linear in both $\bm{\dot{q}}$ and $\bm{u}$ and in the trivial case,
$\bm{\dot{q}} = \bm{u}$, so $f_0 = -f_1$).  Equations (\ref{eq:dyndiffs}) are
the dynamic differential equations
and the time differentiated version of equation \ref{eq:nonholonomic}.
Equation (\ref{eq:dyndiffs}) will necessarily by linear in $\bm{\dot{u}}$, but
generally nonlinear in all other quantities (though often linear in the
external inputs $\bm{r}$).  In this formalism, both independent and dependent
quantities (coordinates and speeds) appear in these equations; we will address
this is shortly.  This following calculations formalism is exceedingly generic;
in practice there is a lot of structure in equations
(\ref{eq:nonholonomic}-\ref{eq:dyndiffs}) that can be leveraged to simplify the
following calculations.  This will be expanded upon below.

The system described by equations \ref{eq:holonomic}-\ref{eq:dyndiffs} has
$o-m$ velocity degrees of freedom.  In state space form, the trajectories of
the system exist in a $p \triangleq n - l + o - m$ dimensional space, though
conserved quantities (e.g., total mechanical energy) may restrict trajectories
to a lower dimensional manifold embedded in this $p$ dimensional space.  In
general this cannot be assumed, however, especially in the presence of external
inputs which may change the total mechanical energy of the system.  While more
than $p$ of the state variables may be of interest (i.e., dependent coordinates
or speeds may be of interest in themselves), only $p$ quantities are truly
independent.  Which of these $p$ coordinates and speeds should be chosen as
independent out of the possible $n + o$ may be obvious for small systems where
there is intuition about the system behavior, but in general the optimal choice
depends on how the configuration $\bm{q}$ affects the gradients of equations
\ref{eq:holonomic} and \ref{eq:nonholonomic}.  On the other hand, in systems
with cyclic (ignorable) coordinates, fewer than $p$ state variables may be of
interest; one example is the Whipple bicycle model where $p=10$ but 5 of these
state variables are cyclic coordinates (coordinates of rear wheel contact
point, heading, and both wheel angles) and are often not of much interest in
themselves, nor are they neccessary for most analyses.

We begin with a first order Taylor series expansion of equations
(\ref{eq:holonomic})-(\ref{eq:dyndiffs}) about an equilibrium
$\bm{q}=\bm{q}^*$, $\bm{\dot{q}}=\bm{\dot{q}}^*$, $\bm{u}=\bm{u}^*$,
$\bm{\dot{u}}=\bm{\dot{u}}^*$, $\bm{r}=\bm{r}^*$ that satisfies equations
(\ref{eq:holonomic})-(\ref{eq:dyndiffs}).  Determining these equilibrium values
generally involves solving (\ref{eq:holonomic})-(\ref{eq:dyndiffs}).  In the interest of brevity, we omit writing this equilibrium after
each gradient in the calculations below; all are evaluated at these equilibrium
conditions.  Taylor series expansion of the constraint equations
(\ref{eq:holonomic}) and (\ref{eq:nonholonomic}) about the equilibrium is
\begin{align}
  \label{eq:holonomic_expansion}
  \bm{f}_{h}(\bm{q}, t) &\approx \underbrace{f_{h}(\bm{q}^*, t)}_{\bm{0}} +
    \nabla_{\bm{q}}f_{h} \cdot \delta \bm{q}\\
  \label{eq:nonholonomic_expansion}
  \bm{f}_{nh}(\bm{q}, \bm{u}, t) &\approx \underbrace{\bm{f}_{nh}(\bm{q}^*,
  \bm{u}^*, t)}_{\bm{0}} +  \nabla_{\bm{q}}f_{nh} \cdot \delta \bm{q} +
  \nabla_{\bm{u}}f_{nh} \cdot \delta \bm{u}
\end{align}
and the first terms are identically zero because of the assumption that the
equilibrium point satisfies the constraints.  The Taylor series expansions of
the functions appearing in the left hand side of equations (\ref{eq:kindiffs})
are
\begin{align}
  \label{eq:f0_expansion}
  \bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t) &\approx \bm{f}_{0}(\bm{q}^*,
  \bm{\dot{q}}^*, t) + \nabla_{\bm{q}}\bm{f}_{0} \cdot \delta\bm{q} +
  \nabla_{\bm{\dot{q}}}\bm{f}_{0} \cdot \delta\bm{\dot{q}}\\
  \label{eq:f1_expansion}
  \bm{f}_{1}(\bm{q}, \bm{u}, t) &\approx \bm{f}_{1}(\bm{q}^*,
  \bm{u}^*, t) + \nabla_{\bm{q}}\bm{f}_{1} \cdot \delta\bm{q} +
  \nabla_{\bm{u}}\bm{f}_{1} \cdot \delta\bm{u}
\end{align}
Summing (\ref{eq:f0_expansion}) and (\ref{eq:f1_expansion}) and recognizing
that the sum of the first term on the right hand side of each equation must
equal zero, we obtain
\begin{align}
  \label{eq:f0_plus_f1_expansion}
  \bm{f}_{0}(\bm{q}, \bm{\dot{q}}, t) + \bm{f}_{1}(\bm{q}, \bm{u}, t) &\approx
  \nabla_{\bm{q}}(\bm{f}_{0} + \bm{f}_{1}) \cdot \delta\bm{q} +
  \nabla_{\bm{\dot{q}}}\bm{f}_{0} \cdot \delta\bm{\dot{q}} +
  \nabla_{\bm{u}}\bm{f}_{1} \cdot \delta\bm{u}
\end{align}
Similarly, a Taylor series expansion of the functions appearing in
the left hand side of (\ref{eq:dyndiffs}) yields
\begin{align}
  \label{eq:f2_expansion}
  \bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t) &\approx
      \bm{f}_{2}(\bm{q}^*, \bm{\dot{u}}^*, t) +
      \nabla_{\bm{q}}\bm{f}_{2} \cdot \delta\bm{q}
      + \nabla_{\bm{\dot{u}}}\bm{f}_{2} \cdot \delta\bm{\dot{u}}\\
  \bm{f}_{3}(\bm{q}, \bm{\dot{q}}, \bm{u}, \bm{r}, t) &\approx
  \bm{f}_{3}(\bm{q}^*, \bm{\dot{q}}^*, \bm{u}^*, \bm{r}^*, t) +
  \nabla_{\bm{q}}\bm{f}_{3} \cdot \delta\bm{q}\notag\\
  \label{eq:f3_expansion}
  &+ \nabla_{\bm{\dot{q}}}\bm{f}_{3} \cdot \delta\bm{\dot{q}}
  + \nabla_{\bm{u}}\bm{f}_{3} \cdot \delta \bm{u}
  + \nabla_{\bm{r}}\bm{f}_{3} \cdot \delta\bm{r}
\end{align}
Summing (\ref{eq:f2_expansion}) and (\ref{eq:f3_expansion}) and recognizing
that the sum of the first term on the right hand sides of these equations must
equal zero, we obtain
\begin{align}
  \bm{f}_{2}(\bm{q}, \bm{\dot{u}}, t) + \bm{f}_{3}(\bm{q}, \bm{\dot{q}},
  \bm{u}, \bm{r}, t) &\approx \nabla_{\bm{q}}(\bm{f}_2 + \bm{f}_3) \cdot
  \delta\bm{q} + \nabla_{\bm{\dot{q}}}\bm{f}_{3} \cdot \delta\bm{\dot{q}}\notag\\
  \label{eq:f2_plus_f3_expansion}
  &+ \nabla_{\bm{u}}\bm{f}_{3} \cdot \delta\bm{u} +
  \nabla_{\bm{\dot{u}}}\bm{f}_{2} \cdot \delta\bm{\dot{u}} + \nabla_{\bm{r}}\bm{f}_{3} \cdot \delta\bm{r}
\end{align}

Utilizing equations (\ref{eq:kindiffs}), (\ref{eq:f0_plus_f1_expansion}),
(\ref{eq:dyndiffs}), and (\ref{eq:f2_plus_f3_expansion}), we introduce the
following quantities
\begin{align}
  M_{00} &\triangleq \nabla_{\bm{\dot{q}}}\bm{f}_0 \\
  M_{11} &\triangleq \nabla_{\bm{\dot{u}}}\bm{f}_2 \\
  A_{00} &\triangleq -\nabla_{\bm{q}}(\bm{f}_0 + \bm{f}_1) \\
  A_{01} &\triangleq -\nabla_{\bm{u}}\bm{f}_1 \\
  A_{10} &\triangleq \nabla_{\bm{q}}(\bm{f}_2 + \bm{f}_3)
  -\nabla_{\bm{\dot{q}}}\bm{f}_3 (\nabla_{\bm{\dot{q}}}\bm{f}_{0})^{-1}
  \nabla_{\bm{q}}(\bm{f}_0 + \bm{f}_1) \\
  A_{11} &\triangleq \nabla_{\bm{u}} \bm{f}_{3} - \nabla_{\bm{\dot{q}}}\bm{f}_{3}
  (\nabla_{\bm{\dot{q}}}\bm{f}_0)^{-1} \nabla_{\bm{u}}\bm{f}_{1} \\
  B_{1} &\triangleq \nabla_{\bm{r}}\bm{f}_{3}
\end{align}

Equating the right hand side of equations (\ref{eq:f0_plus_f1_expansion}) and
(\ref{eq:f2_plus_f3_expansion}) each to zero, eliminating $\bm{\dot{q}}$ from
(\ref{eq:f2_plus_f3_expansion}), and rewriting in matrix form, we obtain
\begin{align}
  \label{eq:state_space_unconstrained}
  \left[
    \begin{array}{cc}
      M_{00} & \bm{0}_{n \times o} \\
      \bm{0}_{o \times n} & M_{11}
    \end{array}
    \right]
    \left[
      \begin{array}{c}
        \delta \bm{\dot{q}} \\
        \delta \bm{\dot{u}}
      \end{array}
    \right]
   &=
   \left[
     \begin{array}{cc}
       A_{00} & A_{01} \\
       A_{10} & A_{11}
     \end{array}
   \right]
    \left[
      \begin{array}{c}
        \delta \bm{q} \\
        \delta \bm{u}
      \end{array}
    \right]
    +
    \left[
      \begin{array}{c}
        \bm{0}_{n \times q} \\
        B_{1}
      \end{array}
    \right]
    \delta \bm{r}
\end{align}
Equation (\ref{eq:state_space_unconstrained}) has a state space of dimension $n
+ o$, yet  only $p = n - l + o - m$ of these quantities are independent, due to
the constraints (equations (\ref{eq:holonomic} and (\ref{eq:nonholonomic})).
To address this issue, one must pick a particular set of independent
coordinates and speeds and appeal to equations (\ref{eq:holonomic_expansion})
and (\ref{eq:nonholonomic_expansion}).  To this end, consider the following
partitioning of the generalized coordinates and generalized speeds:
\begin{equation*}
  \tilde{\bm{q}} \triangleq \left[\begin{array}{cc}\bm{q}_{i} &
      \bm{q}_{d}\end{array}\right]^{T} =  P_{q}^{-1} \bm{q}
      \qquad\qquad
  \tilde{\bm{u}} \triangleq \left[\begin{array}{cc}\bm{u}_{i} &
      \bm{u}_{d}\end{array}\right]^{T} =  P_{u}^{-1} \bm{u}
\end{equation*}
where $P_q \in \mathbf{R}^{n \times n}$ and $P_u \in \mathbf{R}^{o \times o}$
are invertible permutation matrices which map an ordering which has the
independent quantities ($\bm{q}_{i}\in\mathbf{R}^{n-l},\,
\bm{u}_{i}\in\mathbf{R}^{o-m})$ first, followed by the dependent quantities
($\bm{q}_{d}\in\mathbf{R}^{l},\, \bm{u}_{d}\in\mathbf{R}^{m}$) to the
original ordering of the coordinates and speeds.  We use the notation $P_{qi}$
and $P_{qd}$ to denote the first $n-l$ and last $l$ columns of $P_q$,
respectively; similarly, $P_{ui}$ is the first $o-m$ colums of $P_{u}$ while
$P_{ud}$ is the last $m$ columns of $P_u$.

Setting the right hand side of equation (\ref{eq:holonomic_expansion}) equal to
zero, and making use of $P_q$, we have
\begin{align}
  \nabla_{\bm{q}}\bm{f}_{h} P_{q} \cdot \delta \bm{\tilde{q}} &=
  \nabla_{\bm{q}}\bm{f}_{h} P_{qi} \cdot \delta \bm{q_i} +
  \nabla_{\bm{q}}\bm{f}_{h} P_{qd} \cdot \delta \bm{q_d}\notag\\
  &= \bm{0}\notag\\
  \implies \delta \bm{q}_d &= -(\nabla_{\bm{q}}\bm{f}_{h} P_{qd})^{-1}
  (\nabla_{\bm{q}}\bm{f}_{h} P_{qi}) \cdot \delta \bm{q}_i \notag\\
  \implies \delta \bm{q} &= \left[ I_{n \times n} - P_{qd}(\nabla_{\bm{q}}
    \bm{f}_{h} P_{qd})^{-1} \nabla_{\bm{q}} \bm{f}_{h} \right] P_{qi} \cdot \delta
    \bm{q}_i
\end{align}
For convenience, we define
\begin{equation}
  \label{eq:C_0}
  C_0 \triangleq \left[ I_{n \times n} - P_{qd}(\nabla_{\bm{q}}
    \bm{f}_{h} P_{qd})^{-1} \nabla_{\bm{q}} \bm{f}_{h} \right] P_{qi}
\end{equation}
which enables us to write
\begin{align}
  \label{eq:delta_q}
  \delta \bm{q} &= C_0 \cdot \delta \bm{q}_i
\end{align}

Applying the same approach to (\ref{eq:nonholonomic_expansion}), we obtain
\begin{align}
\nabla_{\bm{q}}f_{nh} \cdot \delta \bm{q} +
\nabla_{\bm{u}}f_{nh} \cdot \delta \bm{u} &= \nabla_{\bm{q}} \bm{f}_{nh} \cdot
\delta \bm{q} + \nabla_{\bm{u}} \bm{f}_{nh} P_{ui} \cdot \delta \bm{u}_i +
\nabla_{\bm{u}} \bm{f}_{nh} P_{ud} \cdot \delta \bm{u}_d \notag\\
&= \bm{0}\notag\\
\implies \delta \bm{u}_d &= -\left(\nabla_{\bm{u}} \bm{f}_{nh}
P_{ud}\right)^{-1}\left[\nabla_{\bm{q}}\bm{f}_{nh} \cdot \delta\bm{q} +
  \nabla_{\bm{u}} \bm{f}_{nh} P_{ui} \cdot \delta \bm{u}_i \right]\notag\\
  \implies \delta \bm{u} &= -P_{ud}(\nabla_{\bm{u}} \bm{f}_{nh} P_{ud})^{-1}
  \nabla_{\bm{q}} \bm{f}_{nh} \cdot \delta \bm{q}\notag\\
  &+ \left[I - P_{ud} (\nabla_{\bm{u}}\bm{f}_{nh} P_{ud})^{-1} \nabla_{\bm{u}}
    \bm{f}_{nh} \right] P_{ui} \cdot \delta \bm{u}_i
\end{align}
We define
\begin{align}
  \label{eq:C_1}
  C_1 &\triangleq -P_{ud}(\nabla_{\bm{u}} \bm{f}_{nh} P_{ud})^{-1}
  \nabla_{\bm{q}} \bm{f}_{nh} \\
  \label{eq:C_2}
  C_2 &\triangleq \left[I - P_{ud} (\nabla_{\bm{u}}\bm{f}_{nh} P_{ud})^{-1} \nabla_{\bm{u}}
    \bm{f}_{nh} \right] P_{ui}
\end{align}
which enables us to write
\begin{align}
  \label{eq:delta_u}
  \delta \bm{u} &= C_1 \cdot \delta \bm{q} + C_2 \cdot \delta \bm{u}_i\notag\\
  &= C_1 C_0 \cdot \delta \bm{q}_i + C_2 \cdot \delta \bm{u}_i
\end{align}

By making use of equations (\ref{eq:delta_q}) and (\ref{eq:delta_u}), we can
rewrite equation (\ref{eq:state_space_unconstrained}) as
\begin{align}
  \label{eq:state_space_constrained}
  \left[
    \begin{array}{cc}
      M_{00} & \bm{0}_{n \times o} \\
      \bm{0}_{o \times n} & M_{11}
    \end{array}
    \right]
    \left[
      \begin{array}{c}
        \delta \bm{\dot{q}} \\
        \delta \bm{\dot{u}}
      \end{array}
    \right]
   &=
   \left[
     \begin{array}{cc}
       (A_{00} + A_{01} C_{1}) C_{0} & A_{01} C_{2} \\
       (A_{10} + A_{11} C_{1}) C_{0} & A_{11} C_{2}
     \end{array}
   \right]
    \left[
      \begin{array}{c}
        \delta \bm{q}_i \\
        \delta \bm{u}_i
      \end{array}
    \right]
    +
    \left[
      \begin{array}{c}
        \bm{0}_{n \times q} \\
        B_{1}
      \end{array}
    \right]
    \delta \bm{r}
\end{align}

There are two requirements for this method to work, namely, both
$\nabla_{\bm{q}}\bm{f}_{h} P_{qd}$ and $\nabla_{\bm{u}} \bm{f}_{nh} P_{ud}$
must be nonsingular.  Because of the presence of the permutation matrices, this
implies proper selection of dependent coordinates and dependent speeds is
critical.  The permutation matrices effectively select the columns of the
constraint gradient matrices, and may be selected by examination of the
constraint gradient matrix through a SVD or other numerical techniques; for
small systems it may be possible to choose dependent speeds without resorting
to numerical techniques if the system trajectories stay with the configuration
space where these matrices are nonsingular.

For stability analyses, one must examine the stability of the mapping $\delta
\bm{q}_i \to \bm{\dot{q}}_i$.  This can be done by first solving for
$\delta\bm{\dot{x}} = \left[\delta\bm{\dot{q}},\,\delta\bm{\dot{u}}\right]^{T}$, then selecting
the independent rows of these equations ($n-l+o-m$ of them) to form a square
matrix whose eigenvalues govern the stability of the system about the point of
linearization.

\begin{acknowledgements}
  This material is based upon work partially supported by the National Science
  Foundation under award 0928339 and two Google Summer of Code projects (2009,
  2011).  Aaron Muerer, Brian Granger, Mateuz Paprocki, and Ondrej Certik
  provided valuable help with SymPy and Python.  Jason Moore, Thomas Johnston,
  Evan Sperber, and Andrew Kickertz provided valuable feedback during
  discussions of multibody dynamics and control related issues.
\end{acknowledgements}

% Not sure which bibliography style we are supposed to use
%\bibliographystyle{spbasic}      % basic style, author-year citations
%\bibliographystyle{spmpsci}      % mathematics and physical sciences
%\bibliographystyle{spphys}       % APS-like style for physics
%\bibliography{}   % name your BibTeX data base
\end{document}
